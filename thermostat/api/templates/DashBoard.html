<!DOCTYPE html>
<html>
<head>
    <title>Smart Thermostat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { padding: 16px; background:#f6f8fa; }
        .card { box-shadow: 0 2px 6px rgba(0,0,0,0.06); }
        .small-muted { font-size:0.85em; color:#666; }
        .nowrap { white-space:nowrap; }
        #modal .content { background:white; padding:16px; width:100%; max-width:900px; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex align-items-center mb-4">
        <h1 class="me-3">Smart Thermostat</h1>
        <div class="small-muted">Dashboard</div>
        <div class="ms-auto">
            <button id="refresh-now" class="btn btn-sm btn-outline-primary">Aggiorna</button>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card p-3">
                <h5>Valvole</h5>
                <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-light">
                        <tr><th>ID</th><th>Room</th><th>Setpoint</th><th>State</th><th>Override</th><th>Last seen</th><th>Azioni</th></tr>
                    </thead>
                    <tbody id="valves-tbody"></tbody>
                </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card p-3 mb-3">
                <h5>Stanze</h5>
                    <ul class="list-group mb-3" id="rooms-list">
                    {% for room in rooms %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ room.name }}</strong> <div class="small-muted">id: {{ room.id }}</div>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="badge bg-secondary">{{ room.target_temp }}°C</div>
                                <button data-room="{{ room.id }}" class="btn btn-sm btn-outline-secondary edit-room">Modifica</button>
                                <form method="post" action="/web/rooms/{{ room.id }}/delete" style="display:inline">
                                    <button class="btn btn-sm btn-danger ms-1">Elimina</button>
                                </form>
                            </div>
                        </li>
                    {% else %}
                        <li class="list-group-item">Nessuna stanza registrata.</li>
                    {% endfor %}
                    </ul>

                <h6>Aggiungi Stanza</h6>
                <form id="add-room-form" class="mb-3">
                    <div class="mb-2"><input name="id" class="form-control" placeholder="ID" required></div>
                    <div class="mb-2"><input name="name" class="form-control" placeholder="Nome" required></div>
                    <div class="row gy-2">
                        <div class="col-6"><input name="target_temp" class="form-control" type="number" step="0.1" value="21.0" placeholder="Target"></div>
                        <div class="col-6"><input name="hysteresis" class="form-control" type="number" step="0.1" value="0.5" placeholder="Hysteresis"></div>
                    </div>
                    <div class="mt-2"><button class="btn btn-sm btn-primary">Aggiungi Stanza</button></div>
                </form>
                <div id="edit-room-panel" style="display:none" class="mt-3">
                    <h6>Modifica Stanza</h6>
                    <form id="edit-room-form">
                        <input type="hidden" name="id" id="edit-room-id">
                        <div class="mb-2"><input name="name" id="edit-room-name" class="form-control" placeholder="Nome" required></div>
                        <div class="row gy-2">
                            <div class="col-6"><input name="target_temp" id="edit-room-target" class="form-control" type="number" step="0.1" placeholder="Target"></div>
                            <div class="col-6"><input name="hysteresis" id="edit-room-hysteresis" class="form-control" type="number" step="0.1" placeholder="Hysteresis"></div>
                        </div>
                        <div class="mt-2"><button class="btn btn-sm btn-primary">Salva Modifiche</button> <button id="cancel-edit-room" type="button" class="btn btn-sm btn-secondary ms-2">Annulla</button></div>
                    </form>
                </div>

                <h6>Aggiungi Valvola</h6>
                <form id="add-valve-form">
                    <div class="mb-2"><input name="id" class="form-control" placeholder="Valve ID" required></div>
                    <div class="mb-2"><input name="room_id" class="form-control" placeholder="Room ID (opzionale)"></div>
                    <div><button class="btn btn-sm btn-outline-primary">Aggiungi Valvola</button></div>
                </form>
                <hr>
                <h6>Simulator</h6>
                <form id="sim-start-form" class="mb-2 d-flex gap-2">
                    <input name="valves" id="sim-valves" class="form-control form-control-sm" placeholder="valve1,valve2">
                    <input name="name" id="sim-name" class="form-control form-control-sm" placeholder="instance name" value="sim1" style="width:140px">
                    <button class="btn btn-sm btn-primary">Start</button>
                </form>
                <form id="sim-stop-form" class="d-flex gap-2">
                    <input name="name" id="sim-stop-name" class="form-control form-control-sm" placeholder="instance name" value="sim1" style="width:140px">
                    <button class="btn btn-sm btn-danger">Stop</button>
                </form>

            </div>
        </div>
    </div>

    <div id="modal" class="d-none position-fixed top-0 start-0 w-100 h-100" style="background:rgba(0,0,0,0.5);align-items:center;justify-content:center;display:flex;">
        <div class="content">
            <div class="d-flex mb-2"><button id="close-modal" class="btn btn-sm btn-secondary ms-auto">Chiudi</button></div>
            <canvas id="history-chart" height="200"></canvas>
        </div>
    </div>
</div>

<script>
const valvesData = {{ valves|tojson }};
const roomsData = {{ rooms|tojson }};

function fmtDate(ts){ if(!ts) return ''; return new Date(ts*1000).toLocaleString(); }

function renderValves(valves){
    const tbody = document.getElementById('valves-tbody');
    tbody.innerHTML = '';
    valves.forEach(v => {
        const tr = document.createElement('tr');
        // room select
        let roomOptions = '<option value="">-</option>';
        roomsData.forEach(r => { roomOptions += `<option value="${r.id}" ${v.room_id==r.id? 'selected':''}>${r.name}</option>` });

        const ovBadge = (v.override_heating === null) ? '' : (v.override_heating ? `<span class="badge bg-success">Override ON</span>` : `<span class="badge bg-danger">Override OFF</span>`);
        const ovExp = v.override_expires ? `<div class="small-muted">exp: ${fmtDate(v.override_expires)}</div>` : '';
        let stateBadge = '';
        const st = v.state;
        if (st === null || st === undefined) stateBadge = '';
        else if (Number(st) === 1) stateBadge = `<span class="badge bg-success">HEATING</span>`;
        else if (Number(st) === 0) stateBadge = `<span class="badge bg-secondary">IDLE</span>`;
        else stateBadge = `<span class="badge bg-warning">OFFLINE</span>`;

        tr.innerHTML = `
            <td class="nowrap"><strong>${v.id}</strong></td>
            <td><div class="d-flex gap-2 align-items-center"><select id="sel-${v.id}" class="form-select form-select-sm" style="width:140px">${roomOptions}</select><button data-id="${v.id}" class="btn btn-sm btn-outline-secondary assign-room">Assegna</button></div></td>
            <td><div class="d-flex gap-2 align-items-center"><div>${Number(v.setpoint).toFixed(1)}°C</div><input type="number" step="0.1" id="sp-${v.id}" class="form-control form-control-sm" style="width:90px" placeholder="setpoint"><button data-id="${v.id}" class="btn btn-sm btn-primary sp-send">Invia</button></div></td>
            <td>${stateBadge}</td>
            <td>${ovBadge}${ovExp}</td>
            <td class="small-muted">${fmtDate(v.last_seen)}</td>
            <td class="nowrap">
                <button data-id="${v.id}" class="btn btn-sm btn-outline-info sp-history">Storico</button>
                <button data-id="${v.id}" class="btn btn-sm btn-success force-on">Forza ON</button>
                <button data-id="${v.id}" class="btn btn-sm btn-danger force-off">Forza OFF</button>
                <form method="post" action="/web/valves/${v.id}/delete" style="display:inline">
                    <button class="btn btn-sm btn-outline-danger ms-1">Elimina</button>
                </form>
                <input type="number" id="dur-${v.id}" value="600" class="form-control form-control-sm d-inline-block" style="width:90px;margin-left:6px"> s
            </td>`;
        tbody.appendChild(tr);
    });
}

async function postForm(url, formData){
    const res = await fetch(url, { method: 'POST', body: formData });
    return res;
}

document.getElementById('add-valve-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    await postForm('/web/valves/register', fd);
    await refreshNow();
});

document.getElementById('add-room-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    await postForm('/web/rooms/register', fd);
    location.reload();
});

document.addEventListener('click', async (e)=>{
    if(e.target.classList.contains('sp-send')){
        const id = e.target.dataset.id;
        const val = document.getElementById('sp-'+id).value;
        const fd = new FormData(); fd.append('setpoint', val);
        await postForm(`/web/valves/${id}/setpoint`, fd);
        alert('Setpoint inviato');
        await refreshNow();
    }
    if(e.target.classList.contains('sp-history')){
        const id = e.target.dataset.id;
        showHistory(id);
    }
    if(e.target.classList.contains('assign-room')){
        const id = e.target.dataset.id;
        const sel = document.getElementById('sel-'+id);
        const room = sel.value;
        const fd = new FormData(); fd.append('room_id', room);
        await postForm(`/web/valves/${id}/assign`, fd);
        await refreshNow();
    }
    if(e.target.classList.contains('edit-room')){
        const roomId = e.target.dataset.room;
        // fetch room details from roomsData
        const room = roomsData.find(r => r.id == roomId);
        if(!room) return;
        document.getElementById('edit-room-panel').style.display = 'block';
        document.getElementById('edit-room-id').value = room.id;
        document.getElementById('edit-room-name').value = room.name;
        document.getElementById('edit-room-target').value = room.target_temp;
        document.getElementById('edit-room-hysteresis').value = room.hysteresis;
        window.scrollTo({ top: document.getElementById('edit-room-panel').offsetTop - 80, behavior: 'smooth' });
    }
    if(e.target.classList.contains('force-on') || e.target.classList.contains('force-off')){
        const id = e.target.dataset.id;
        const heating = e.target.classList.contains('force-on') ? 'true' : 'false';
        const durElem = document.getElementById('dur-'+id);
        const duration = durElem ? parseInt(durElem.value || '600') : 600;
        const fd = new FormData(); fd.append('heating', heating); fd.append('duration', duration);
        await postForm(`/web/valves/${id}/command`, fd);
        alert('Comando inviato');
        await refreshNow();
    }
});

document.getElementById('edit-room-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = document.getElementById('edit-room-id').value;
    const fd = new FormData(e.target);
    await postForm(`/web/rooms/${id}/edit`, fd);
    document.getElementById('edit-room-panel').style.display = 'none';
    location.reload();
});

document.getElementById('cancel-edit-room').addEventListener('click', ()=>{ document.getElementById('edit-room-panel').style.display='none'; });

let chart = null;
async function showHistory(id){
    const res = await fetch(`/valves/${id}/history?limit=100`);
    if(!res.ok){ alert('No history'); return; }
    const data = await res.json();
    const labels = data.map(r => new Date(r.timestamp*1000).toLocaleString()).reverse();
    const values = data.map(r => r.temperature).reverse();
    document.getElementById('modal').classList.remove('d-none');
    const ctx = document.getElementById('history-chart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: id, data: values, borderColor:'#007bff' }] } });
}

document.getElementById('close-modal').addEventListener('click', ()=>{ document.getElementById('modal').classList.add('d-none'); });

async function refreshNow(){
    try{
        const res = await fetch('/valves');
        if(!res.ok) return;
        const data = await res.json();
        renderValves(data);
    }catch(e){ console.error(e); }
}

document.getElementById('refresh-now').addEventListener('click', refreshNow);

// initial render and periodic refresh
renderValves(valvesData);
setInterval(refreshNow, 5000);

// Simulator start/stop handlers
document.getElementById('sim-start-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/web/simulators/start', { method: 'POST', body: fd });
    const j = await res.json();
    alert(JSON.stringify(j));
});

document.getElementById('sim-stop-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/web/simulators/stop', { method: 'POST', body: fd });
    const j = await res.json();
    alert(JSON.stringify(j));
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
